#include <Arduino.h>
#include <U8g2lib.h>
#include <Wire.h>
#include "AudioTools.h"
#include "BluetoothA2DPSink.h"

// ----------------- PIN -----------------
#define SDA 2
#define SCL 15
#define I2S_BCLK 25
#define I2S_LRCLK 27
#define I2S_DOUT 26
#define BTN_PIN 32   // GPIO sicuro

// ----------------- DISPLAY -----------------
U8G2_SH1106_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, U8X8_PIN_NONE, SCL, SDA);
// ----------------- AUDIO / BT -----------------
I2SStream i2s;
BluetoothA2DPSink a2dp_sink(i2s);

// ----------------- STATO -----------------
String currentTrack = "";
String currentDevice = "";
bool isConnected = false;
bool isPaused = false;
bool pairingMode = true;
bool sleepMode = false;
unsigned long lastActivity = 0;

// ----------------- BITMAP -----------------
/* --- play --- */
static const unsigned char image_play_hover_bits[] U8X8_PROGMEM = {
  0xfc,0xff,0x01,0xfe,0xff,0x03,0xff,0xff,0x07,0xff,0xff,0x07,
  0x7f,0xfe,0x07,0x7f,0xfc,0x07,0x7f,0xf8,0x07,0x7f,0xf0,0x07,
  0x7f,0xe0,0x07,0x7f,0xc0,0x07,0x7f,0xe0,0x07,0x7f,0xf0,0x07,
  0x7f,0xf8,0x07,0x7f,0xfc,0x07,0x7f,0xfe,0x07,0xff,0xff,0x07,
  0xff,0xff,0x07,0xff,0xff,0x07,0xfe,0xff,0x03,0xfc,0xff,0x01
};

/* --- pausa --- */
static const unsigned char image_pause_hover_bits[] U8X8_PROGMEM = {
  0xfc,0xff,0x01,0xfe,0xff,0x03,0xff,0xff,0x07,0xff,0xff,0x07,
  0x1f,0xc7,0x07,0x1f,0xc7,0x07,0x1f,0xc7,0x07,0x1f,0xc7,0x07,
  0x1f,0xc7,0x07,0x1f,0xc7,0x07,0x1f,0xc7,0x07,0x1f,0xc7,0x07,
  0x1f,0xc7,0x07,0x1f,0xc7,0x07,0x1f,0xc7,0x07,0xff,0xff,0x07,
  0xff,0xff,0x07,0xff,0xff,0x07,0xfe,0xff,0x03,0xfc,0xff,0x01
};

/* --- BLE icon --- */
static const unsigned char image_Ble_connected_bits[] U8X8_PROGMEM = {
  0xe0,0x03,0xf8,0x0f,0x7c,0x1f,0x7e,0x3e,0x6e,0x3d,0x5f,0x7b,
  0x3f,0x7d,0x7f,0x7e,0x3f,0x7d,0x5f,0x7b,0x6e,0x3d,0x7e,0x3e,
  0x7c,0x1f,0xf8,0x0f,0xe0,0x03  
};

/* --- logo --- */
static const unsigned char image_logo_bits[] U8X8_PROGMEM = {
  // 'imgbitmap_png, 38x18px
	0x00, 0xf0, 0x3f, 0x00, 0x0c, 0x00, 0xf0, 0x3f, 0x00, 0x0c, 0x00, 0xf0, 0x3f, 0x00, 0x0f, 0x00, 
	0xf0, 0x3f, 0x00, 0x0f, 0x00, 0xff, 0xff, 0xf0, 0x03, 0x00, 0xff, 0xff, 0xf0, 0x03, 0xc0, 0x0f, 
	0xf0, 0xfc, 0x00, 0xc0, 0x0f, 0xf0, 0xfc, 0x00, 0xff, 0xc0, 0xf3, 0xff, 0x3f, 0xff, 0xc0, 0xf3, 
	0xff, 0x3f, 0xff, 0xff, 0xcf, 0xc3, 0x3f, 0xff, 0xff, 0xcf, 0xc3, 0x3f, 0xc0, 0xff, 0x0f, 0xfc, 
	0x00, 0xc0, 0xff, 0x0f, 0xfc, 0x00, 0xf0, 0x03, 0xff, 0x3f, 0x00, 0xf0, 0x03, 0xff, 0x3f, 0x00, 
	0x30, 0x00, 0xfc, 0x0f, 0x00, 0x30, 0x00, 0xfc, 0x0f, 0x00
};

// ----------------- CALLBACK -----------------
void avrc_metadata_callback(uint8_t attr, const uint8_t *data) {
  if (attr == ESP_AVRC_MD_ATTR_TITLE) {
    currentTrack = (const char*)data;
  }
  lastActivity = millis();
  sleepMode = false;
}

void connection_state_changed(esp_a2d_connection_state_t state, void *) {
  isConnected = (state == ESP_A2D_CONNECTION_STATE_CONNECTED);
  pairingMode = !isConnected;
  if (isConnected) currentDevice = a2dp_sink.get_remote_name();
  else {
    currentTrack = "track not avaible";
    currentDevice = "name not avaible";
  }
  lastActivity = millis();
  sleepMode = false;
}

void playback_state_callback(esp_avrc_playback_stat_t state) {
  isPaused = (state != ESP_AVRC_PLAYBACK_PLAYING);
  lastActivity = millis();
}

// ----------------- SCROLL -----------------
static int scrollX = 128;
static unsigned long lastScroll = 0;
static String lastTrack = "";
#define TEXT_X 28

void drawScrollingText(const char* text, int y) {
  if (lastTrack != text) {
    scrollX = TEXT_X;
    lastTrack = text;
  }

  int w = u8g2.getStrWidth(text);
  int maxWidth = 128 - TEXT_X;

  // Se il testo entra nello spazio disponibile
  if (w <= maxWidth) {
    u8g2.setClipWindow(TEXT_X, 0, 128, 64);
    u8g2.drawStr(TEXT_X, y, text);
    u8g2.setMaxClipWindow();
    return;
  }

  if (millis() - lastScroll > 200 && !isPaused) {
    scrollX--;

    if (scrollX < TEXT_X - w) {
      scrollX = 128;
    }

    lastScroll = millis();
  }

  // CLIPPING ATTIVO
  u8g2.setClipWindow(TEXT_X, 0, 128, 64);
  u8g2.drawStr(scrollX, y, text);
  u8g2.setMaxClipWindow();
}


// ----------------- SCHERMATE -----------------
void showNowPlaying() {
  u8g2.clearBuffer();
  u8g2.setFontMode(1);
  u8g2.setBitmapMode(1);

  u8g2.drawXBMP(90, 1, 38, 18, image_logo_bits);

  if (isPaused)
    u8g2.drawXBMP(2, 15, 19, 20, image_pause_hover_bits);
  else
    u8g2.drawXBMP(2, 15, 19, 20, image_play_hover_bits);

  u8g2.drawXBMP(2, 44, 15, 15, image_Ble_connected_bits);

  // Font con accenti
  u8g2.setFont(u8g2_font_6x12_tr);

  // Header abbassato di 1 px
  u8g2.drawStr(0, 9, "Nexo - BT");

  // Titolo brano (scroll) abbassato di 1 px
  if (currentTrack.length())
    drawScrollingText(currentTrack.c_str(), 31);

  // Nome dispositivo abbassato di 1 px
  if (currentDevice.length())
    u8g2.drawStr(23, 56, currentDevice.c_str());

  u8g2.drawLine(1, 40, 127, 40);
  u8g2.sendBuffer();
}


void showPairing() {
  static unsigned long lastBlink = 0;
  static bool visible = true;

  if (millis() - lastBlink > 500) {
    visible = !visible;
    lastBlink = millis();
  }

  u8g2.clearBuffer();
  u8g2.setFontMode(1);
  u8g2.setBitmapMode(1);

  // --- Icona BLE centrata ---
  if (visible) {
    u8g2.drawXBMP(57, 20, 15, 15, image_Ble_connected_bits);
  }

  // --- Testo PAIRING centrato sotto ---
  u8g2.setFont(u8g2_font_6x10_tr);
  const char* txt = "PAIRING";
  int txtW = u8g2.getStrWidth(txt);
  u8g2.drawStr((128 - txtW) / 2, 45, txt);

  // --- Testi/elementi lasciati invariati ---
  u8g2.drawStr(0, 8, "Nexo - BT");
  u8g2.drawXBMP(90, 1, 38, 18, image_logo_bits);

  u8g2.sendBuffer();
}

void showSleep() {
  u8g2.clearBuffer();
  u8g2.setFontMode(1);
  u8g2.setBitmapMode(1);
  u8g2.setFont(u8g2_font_timR18_tr);
  u8g2.drawStr(11, 45, "Nexo - BT");
  u8g2.setFont(u8g2_font_6x10_tr);
  u8g2.drawStr(34, 60, "SLEEP MODE");
  u8g2.drawXBMP(45, 10, 38, 18, image_logo_bits);
  u8g2.sendBuffer();
}

// ----------------- SETUP -----------------
void setup() {
  u8g2.begin();

  auto cfg = i2s.defaultConfig();
  cfg.pin_bck = I2S_BCLK;
  cfg.pin_ws = I2S_LRCLK;
  cfg.pin_data = I2S_DOUT;
  i2s.begin(cfg);

  pinMode(BTN_PIN, INPUT_PULLUP);

  a2dp_sink.set_avrc_metadata_callback(avrc_metadata_callback);
  a2dp_sink.set_avrc_metadata_attribute_mask(ESP_AVRC_MD_ATTR_TITLE);
  a2dp_sink.set_avrc_rn_playstatus_callback(playback_state_callback);
  a2dp_sink.set_on_connection_state_changed(connection_state_changed);
  a2dp_sink.start("NEXO-BT");

  lastActivity = millis();
}

// ----------------- LOOP -----------------
void loop() {
  static bool lastBtn = HIGH;
  bool btn = digitalRead(BTN_PIN);

  if(currentDevice == "name not avaible" || currentDevice == ""){
    currentDevice = a2dp_sink.get_remote_name();
  }

  if (btn == LOW && lastBtn == HIGH) {
    a2dp_sink.disconnect();
    pairingMode = true;
    sleepMode = false;
    lastActivity = millis();
  }
  lastBtn = btn;

  if (!isConnected && millis() - lastActivity > 60000) {
    sleepMode = true;
  }

  if (sleepMode) showSleep();
  else if (!isConnected || pairingMode) showPairing();
  else showNowPlaying();

  delay(100);
}
